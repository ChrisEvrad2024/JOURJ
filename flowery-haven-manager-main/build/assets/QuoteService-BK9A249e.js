var T=Object.defineProperty;var S=(c,e,r)=>e in c?T(c,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):c[e]=r;var u=(c,e,r)=>S(c,typeof e!="symbol"?e+"":e,r);import{ax as a,ay as n,az as i,aA as U}from"./index-D2Ipw2YP.js";class E{static async getUserQuotes(e=null){try{const r=a.getCurrentUser();if(!e&&!r)throw new Error("Utilisateur non connecté");const s=e||r.id;if(r.id!==s&&r.role!=="admin")throw new Error("Accès non autorisé");return(await n.getByIndex(i.QUOTES,"userId",s)).sort((o,d)=>new Date(d.createdAt)-new Date(o.createdAt))}catch(r){throw console.error("Erreur lors de la récupération des devis:",r),r}}static async getQuoteById(e){try{const r=a.getCurrentUser();if(!r)throw new Error("Utilisateur non connecté");const s=await n.getByKey(i.QUOTES,e);if(!s)return null;if(s.userId!==r.id&&r.role!=="admin")throw new Error("Accès non autorisé");return s}catch(r){throw console.error(`Erreur lors de la récupération du devis ${e}:`,r),r}}static async createQuote(e){try{const r=a.getCurrentUser();if(!r)throw new Error("Utilisateur non connecté");if(!Object.values(this.QUOTE_TYPES).includes(e.type))throw new Error("Type de devis invalide");const s={id:`QUOTE-${Date.now()}`,userId:r.id,type:e.type,title:e.title,description:e.description,eventDate:e.eventDate,budget:e.budget,contactName:e.contactName||`${r.firstName} ${r.lastName}`,contactEmail:e.contactEmail||r.email,contactPhone:e.contactPhone,status:this.QUOTE_STATUS.PENDING,files:e.files||[],createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};return await n.add(i.QUOTES,s),s}catch(r){throw console.error("Erreur lors de la création du devis:",r),r}}static async updateQuoteStatus(e,r,s=""){try{const t=a.getCurrentUser();if(!t)throw new Error("Utilisateur non connecté");const o=await n.getByKey(i.QUOTES,e);if(!o)throw new Error("Devis non trouvé");if(r===this.QUOTE_STATUS.IN_PROGRESS||r===this.QUOTE_STATUS.SENT){if(t.role!=="admin")throw new Error("Accès non autorisé")}else if(r===this.QUOTE_STATUS.ACCEPTED||r===this.QUOTE_STATUS.DECLINED){if(o.userId!==t.id)throw new Error("Accès non autorisé")}else if(t.role!=="admin")throw new Error("Accès non autorisé");if(!Object.values(this.QUOTE_STATUS).includes(r))throw new Error("Statut de devis invalide");return o.status=r,o.statusHistory=o.statusHistory||[],o.statusHistory.push({status:r,date:new Date().toISOString(),notes:s,updatedBy:t.id}),o.updatedAt=new Date().toISOString(),await n.update(i.QUOTES,o),o}catch(t){throw console.error(`Erreur lors de la mise à jour du statut du devis ${e}:`,t),t}}static async addProposal(e,r){try{const s=a.getCurrentUser();if(!s||s.role!=="admin")throw new Error("Accès non autorisé");const t=await n.getByKey(i.QUOTES,e);if(!t)throw new Error("Devis non trouvé");const o={id:U(),amount:r.amount,description:r.description,items:r.items||[],validUntil:r.validUntil,termsAndConditions:r.termsAndConditions,createdBy:s.id,createdAt:new Date().toISOString()};return t.proposal=o,t.status=this.QUOTE_STATUS.SENT,t.statusHistory=t.statusHistory||[],t.statusHistory.push({status:this.QUOTE_STATUS.SENT,date:new Date().toISOString(),notes:"Proposition de devis envoyée",updatedBy:s.id}),t.updatedAt=new Date().toISOString(),await n.update(i.QUOTES,t),t}catch(s){throw console.error(`Erreur lors de l'ajout d'une proposition au devis ${e}:`,s),s}}static async acceptQuote(e,r=""){try{const s=a.getCurrentUser();if(!s)throw new Error("Utilisateur non connecté");const t=await n.getByKey(i.QUOTES,e);if(!t)throw new Error("Devis non trouvé");if(t.userId!==s.id)throw new Error("Accès non autorisé");if(!t.proposal)throw new Error("Ce devis n'a pas encore de proposition");if(t.status===this.QUOTE_STATUS.ACCEPTED||t.status===this.QUOTE_STATUS.DECLINED||t.status===this.QUOTE_STATUS.COMPLETED)throw new Error(`Ce devis est déjà ${t.status}`);if(t.proposal.validUntil&&new Date(t.proposal.validUntil)<new Date)throw t.status=this.QUOTE_STATUS.EXPIRED,t.statusHistory=t.statusHistory||[],t.statusHistory.push({status:this.QUOTE_STATUS.EXPIRED,date:new Date().toISOString(),notes:"Devis expiré",updatedBy:s.id}),await n.update(i.QUOTES,t),new Error("Ce devis a expiré");return t.status=this.QUOTE_STATUS.ACCEPTED,t.statusHistory=t.statusHistory||[],t.statusHistory.push({status:this.QUOTE_STATUS.ACCEPTED,date:new Date().toISOString(),notes:r||"Devis accepté par le client",updatedBy:s.id}),t.acceptedAt=new Date().toISOString(),t.updatedAt=new Date().toISOString(),await n.update(i.QUOTES,t),t}catch(s){throw console.error(`Erreur lors de l'acceptation du devis ${e}:`,s),s}}static async declineQuote(e,r){try{const s=a.getCurrentUser();if(!s)throw new Error("Utilisateur non connecté");const t=await n.getByKey(i.QUOTES,e);if(!t)throw new Error("Devis non trouvé");if(t.userId!==s.id)throw new Error("Accès non autorisé");if(t.status===this.QUOTE_STATUS.ACCEPTED||t.status===this.QUOTE_STATUS.DECLINED||t.status===this.QUOTE_STATUS.COMPLETED)throw new Error(`Ce devis est déjà ${t.status}`);return t.status=this.QUOTE_STATUS.DECLINED,t.statusHistory=t.statusHistory||[],t.statusHistory.push({status:this.QUOTE_STATUS.DECLINED,date:new Date().toISOString(),notes:`Devis refusé par le client: ${r}`,updatedBy:s.id}),t.declinedAt=new Date().toISOString(),t.declineReason=r,t.updatedAt=new Date().toISOString(),await n.update(i.QUOTES,t),t}catch(s){throw console.error(`Erreur lors du refus du devis ${e}:`,s),s}}static async getAllQuotes(e={}){try{const r=a.getCurrentUser();if(!r||r.role!=="admin")throw new Error("Accès non autorisé");let s=await n.getAll(i.QUOTES);return e.status&&(s=s.filter(t=>t.status===e.status)),e.type&&(s=s.filter(t=>t.type===e.type)),s.sort((t,o)=>new Date(o.createdAt)-new Date(t.createdAt))}catch(r){throw console.error("Erreur lors de la récupération de tous les devis:",r),r}}static async getPendingQuotes(){try{const e=a.getCurrentUser();if(!e||e.role!=="admin")throw new Error("Accès non autorisé");return(await n.getByIndex(i.QUOTES,"status",this.QUOTE_STATUS.PENDING)).sort((s,t)=>new Date(s.createdAt)-new Date(t.createdAt))}catch(e){throw console.error("Erreur lors de la récupération des devis en attente:",e),e}}}u(E,"QUOTE_STATUS",{PENDING:"pending",IN_PROGRESS:"in_progress",SENT:"sent",ACCEPTED:"accepted",DECLINED:"declined",EXPIRED:"expired",COMPLETED:"completed"}),u(E,"QUOTE_TYPES",{EVENT:"event",CORPORATE:"corporate",DECORATION:"decoration",CUSTOM:"custom"});export{E as Q};
