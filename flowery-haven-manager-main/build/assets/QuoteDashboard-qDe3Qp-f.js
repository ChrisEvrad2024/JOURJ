import{i as I,r as m,h as X,j as e,B as h,L as V,$ as S,V as J,C as $,X as _,J as v}from"./index-D2Ipw2YP.js";import{T as G,a as K,b as D,c as W}from"./tabs-BkT1Db25.js";import{C as O,a as Y,b as Z,d as q,c as U,e as ee}from"./card-CcKSh10K.js";import{Q as j}from"./QuoteService-BK9A249e.js";import{D as se,a as te,b as re,c as ae,d as le,e as ie}from"./dialog-Bh1R_dux.js";import{A as ne,b as ce,c as de,d as oe,e as ue,f as me,g as xe,h as he}from"./alert-dialog-IJ8aKrw7.js";import{S as L}from"./separator-B4UgFw64.js";import{C as N}from"./clock-CXcy2a79.js";import{F as pe}from"./file-text-DtHEMwOT.js";import{S as je}from"./send-XyahvlRz.js";import{f as fe}from"./format-BxPkkDNt.js";import{f as ge}from"./fr-BSv8k3uD.js";import"./index-BycQlkId.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=I("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]),Ne=()=>{const[n,d]=m.useState([]),[t,g]=m.useState(!0),[w,i]=m.useState(null),{currentUser:c}=X();return m.useEffect(()=>{if(!c){d([]),g(!1);return}(async()=>{try{g(!0),i(null);const a=c.role==="admin"?await j.getAllQuotes():await j.getUserQuotes(c.id);d(a)}catch(a){console.error("Erreur lors du chargement des devis:",a),i(a.message||"Erreur lors du chargement des devis")}finally{g(!1)}})()},[c]),{quotes:n,loading:t,error:w,createQuote:async l=>{try{const a=await j.createQuote(l);return d([a,...n]),a}catch(a){throw console.error("Erreur lors de la création du devis:",a),i(a.message||"Erreur lors de la création du devis"),a}},acceptQuote:async(l,a="")=>{try{return await j.acceptQuote(l,a),d(n.map(r=>r.id===l?{...r,status:"accepted",statusHistory:[...r.statusHistory||[],{status:"accepted",date:new Date().toISOString(),notes:a||"Devis accepté"}],acceptedAt:new Date().toISOString()}:r)),!0}catch(r){return console.error(`Erreur lors de l'acceptation du devis ${l}:`,r),i(r.message||"Erreur lors de l'acceptation du devis"),!1}},declineQuote:async(l,a)=>{try{return await j.declineQuote(l,a),d(n.map(r=>r.id===l?{...r,status:"declined",statusHistory:[...r.statusHistory||[],{status:"declined",date:new Date().toISOString(),notes:`Devis refusé: ${a}`}],declinedAt:new Date().toISOString(),declineReason:a}:r)),!0}catch(r){return console.error(`Erreur lors du refus du devis ${l}:`,r),i(r.message||"Erreur lors du refus du devis"),!1}},getQuoteById:l=>n.find(a=>a.id===l)||null,getQuotesByStatus:l=>!l||l==="all"?n:n.filter(a=>a.status===l),updateQuoteStatus:async(l,a,r="")=>{if(!c||c.role!=="admin")return i("Permission refusée"),!1;try{return await j.updateQuoteStatus(l,a,r),d(n.map(o=>o.id===l?{...o,status:a,statusHistory:[...o.statusHistory||[],{status:a,date:new Date().toISOString(),notes:r}]}:o)),!0}catch(o){return console.error(`Erreur lors de la mise à jour du statut du devis ${l}:`,o),i(o.message||"Erreur lors de la mise à jour du statut du devis"),!1}},addProposal:async(l,a)=>{if(!c||c.role!=="admin")return i("Permission refusée"),!1;try{return await j.addProposal(l,a),d(n.map(r=>r.id===l?{...r,status:"sent",proposal:{...a,id:`prop-${Date.now()}`,createdBy:c.id,createdAt:new Date().toISOString()},statusHistory:[...r.statusHistory||[],{status:"sent",date:new Date().toISOString(),notes:"Proposition de devis envoyée"}]}:r)),!0}catch(r){return console.error(`Erreur lors de l'ajout d'une proposition au devis ${l}:`,r),i(r.message||"Erreur lors de l'ajout d'une proposition au devis"),!1}}}},f={pending:{label:"En attente",color:"bg-yellow-50 text-yellow-700 border-yellow-200",icon:e.jsx(N,{className:"h-4 w-4"})},in_progress:{label:"En cours",color:"bg-blue-50 text-blue-700 border-blue-200",icon:e.jsx(N,{className:"h-4 w-4"})},sent:{label:"Devis envoyé",color:"bg-purple-50 text-purple-700 border-purple-200",icon:e.jsx(je,{className:"h-4 w-4"})},accepted:{label:"Accepté",color:"bg-green-50 text-green-700 border-green-200",icon:e.jsx($,{className:"h-4 w-4"})},declined:{label:"Refusé",color:"bg-red-50 text-red-700 border-red-200",icon:e.jsx(_,{className:"h-4 w-4"})},expired:{label:"Expiré",color:"bg-gray-50 text-gray-700 border-gray-200",icon:e.jsx(N,{className:"h-4 w-4"})},completed:{label:"Terminé",color:"bg-green-50 text-green-700 border-green-200",icon:e.jsx($,{className:"h-4 w-4"})}},ze=()=>{var F,H,z,P;const[n,d]=m.useState("all"),[t,g]=m.useState(null),[w,i]=m.useState(!1),[c,b]=m.useState(!1),[y,C]=m.useState(""),{quotes:p,loading:A,error:Q,acceptQuote:E,declineQuote:l}=Ne(),a=n==="all"?p:p.filter(s=>s.status===n),r=s=>{try{return fe(new Date(s),"PPP",{locale:ge})}catch{return s||"Date non spécifiée"}},o=s=>{g(s),i(!0)},k=async s=>{try{await E(s)&&(v.success("Devis accepté",{description:"Le devis a été accepté avec succès."}),i(!1))}catch{v.error("Erreur",{description:"Une erreur est survenue lors de l'acceptation du devis."})}},T=s=>{C(""),b(!0)},M=async()=>{if(t)try{if(!y){v.error("Veuillez indiquer une raison",{description:"Une raison est requise pour refuser le devis."});return}await l(t.id,y)&&(v.success("Devis refusé",{description:"Le devis a été refusé."}),b(!1),i(!1))}catch{v.error("Erreur",{description:"Une erreur est survenue lors du refus du devis."})}};return A?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-serif",children:"Mes devis"}),e.jsx("p",{className:"text-muted-foreground",children:"Chargement de vos devis..."})]}),e.jsx("div",{className:"animate-pulse space-y-4",children:[1,2,3].map(s=>e.jsx("div",{className:"h-40 bg-muted rounded-lg"},s))})]}):Q?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-serif",children:"Mes devis"}),e.jsx("p",{className:"text-red-500",children:"Une erreur est survenue lors du chargement de vos devis."}),e.jsx("p",{className:"text-muted-foreground mt-2",children:Q})]})}):e.jsxs("div",{className:"space-y-8",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-serif",children:"Mes devis"}),e.jsx("p",{className:"text-muted-foreground",children:"Consultez et gérez vos demandes de devis personnalisés."})]}),e.jsx(h,{asChild:!0,children:e.jsxs(V,{to:"/quote",className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-4 w-4"}),"Demander un devis"]})})]}),e.jsxs(G,{defaultValue:"all",value:n,onValueChange:d,children:[e.jsxs(K,{className:"mb-6",children:[e.jsxs(D,{value:"all",children:["Tous (",p.length,")"]}),e.jsxs(D,{value:"pending",children:["En attente (",p.filter(s=>s.status==="pending").length,")"]}),e.jsxs(D,{value:"sent",children:["Reçus (",p.filter(s=>s.status==="sent").length,")"]}),e.jsxs(D,{value:"accepted",children:["Acceptés (",p.filter(s=>s.status==="accepted").length,")"]})]}),e.jsx(W,{value:n,className:"space-y-4",children:a.length>0?a.map(s=>{var u,x,R,B;return e.jsxs(O,{children:[e.jsx(Y,{className:"pb-2",children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{children:[e.jsx(Z,{className:"text-base",children:s.title||`Devis ${s.type}`}),e.jsxs(q,{children:["Demande effectuée le ",r(s.createdAt)]})]}),e.jsxs(S,{variant:"outline",className:`${((u=f[s.status])==null?void 0:u.color)||"bg-gray-50 text-gray-700"} flex items-center gap-1`,children:[((x=f[s.status])==null?void 0:x.icon)||e.jsx(N,{className:"h-4 w-4"}),((R=f[s.status])==null?void 0:R.label)||s.status]})]})}),e.jsxs(U,{children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Type d'événement"}),e.jsx("p",{className:"font-medium capitalize",children:s.type||"Non spécifié"})]}),s.eventDate&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Date d'événement"}),e.jsx("p",{className:"font-medium",children:r(s.eventDate)})]}),s.budget&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground",children:"Budget"}),e.jsx("p",{className:"font-medium",children:s.budget})]})]}),s.status==="sent"&&s.proposal&&e.jsxs("div",{className:"mt-4 p-3 bg-blue-50 text-blue-800 rounded-md",children:[e.jsxs("p",{className:"font-medium",children:["Proposition reçue: ",((B=s.proposal.amount)==null?void 0:B.toFixed(2))||"0,00"," XAF"]}),e.jsxs("p",{className:"text-sm text-blue-700",children:["Valable jusqu'au ",r(s.proposal.validUntil)]})]})]}),e.jsxs(ee,{className:"pt-0 flex justify-between",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:()=>o(s),children:["Voir détails",e.jsx(J,{className:"h-4 w-4 ml-1"})]}),s.status==="sent"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{size:"sm",variant:"outline",className:"border-red-300 text-red-600 hover:bg-red-50",onClick:()=>{g(s),T()},children:"Refuser"}),e.jsx(h,{size:"sm",className:"bg-green-600 hover:bg-green-700",onClick:()=>k(s.id),children:"Accepter"})]})]})]},s.id)}):e.jsx(O,{children:e.jsxs(U,{className:"flex flex-col items-center justify-center py-12",children:[e.jsx("div",{className:"rounded-full bg-muted w-12 h-12 flex items-center justify-center mb-4",children:e.jsx(pe,{className:"h-6 w-6 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-medium",children:"Aucun devis trouvé"}),e.jsx("p",{className:"text-muted-foreground mt-1 text-center",children:"Vous n'avez pas encore de devis dans cette catégorie."}),e.jsx(h,{asChild:!0,className:"mt-4",children:e.jsx(V,{to:"/quote",children:"Demander un devis"})})]})})})]}),e.jsx(se,{open:w,onOpenChange:i,children:e.jsxs(te,{className:"sm:max-w-[600px]",children:[e.jsxs(re,{children:[e.jsx(ae,{children:(t==null?void 0:t.title)||"Détails du devis"}),e.jsxs(le,{children:["Demande effectuée le ",t?r(t.createdAt):""]})]}),t&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center",children:e.jsxs(S,{variant:"outline",className:`${((F=f[t.status])==null?void 0:F.color)||"bg-gray-50 text-gray-700"} flex items-center gap-1`,children:[((H=f[t.status])==null?void 0:H.icon)||e.jsx(N,{className:"h-4 w-4"}),((z=f[t.status])==null?void 0:z.label)||t.status]})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-1",children:"Type d'événement"}),e.jsx("p",{className:"capitalize",children:t.type||"Non spécifié"})]}),t.eventDate&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-1",children:"Date d'événement"}),e.jsx("p",{children:r(t.eventDate)})]}),t.budget&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-1",children:"Budget"}),e.jsx("p",{children:t.budget})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-1",children:"Contact"}),e.jsx("p",{children:t.contactName||"Non spécifié"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium mb-1",children:"Description"}),e.jsx("p",{className:"text-muted-foreground whitespace-pre-line",children:t.description})]}),t.status==="sent"&&t.proposal&&e.jsxs(e.Fragment,{children:[e.jsx(L,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsx("h4",{className:"text-base font-medium",children:"Proposition de devis"}),e.jsxs(S,{variant:"outline",className:"bg-blue-50 text-blue-700",children:["Validité: ",r(t.proposal.validUntil)]})]}),e.jsxs("div",{className:"bg-blue-50 p-4 rounded-md",children:[e.jsxs("h3",{className:"text-lg font-medium text-blue-900",children:[((P=t.proposal.amount)==null?void 0:P.toFixed(2))||"0,00"," XAF"]}),e.jsx("p",{className:"text-blue-700 mt-1",children:t.proposal.description}),t.proposal.items&&t.proposal.items.length>0&&e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsx("h5",{className:"text-sm font-medium text-blue-900",children:"Détails de la proposition"}),t.proposal.items.map((s,u)=>{var x;return e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{children:[s.name||"Élément"," x",s.quantity||1]}),e.jsxs("span",{children:[((x=s.price)==null?void 0:x.toFixed(2))||"0,00"," XAF"]})]},u)})]}),t.proposal.termsAndConditions&&e.jsx("div",{className:"mt-3 text-xs text-blue-600",children:e.jsx("p",{children:t.proposal.termsAndConditions})})]})]})]}),t.statusHistory&&t.statusHistory.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(L,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium",children:"Historique des statuts"}),e.jsx("div",{className:"space-y-2",children:t.statusHistory.map((s,u)=>{var x;return e.jsxs("div",{className:"text-sm flex items-start",children:[e.jsx("div",{className:"w-24 flex-shrink-0 text-muted-foreground",children:r(s.date)}),e.jsxs("div",{className:"flex-1",children:[e.jsx("span",{className:"font-medium",children:((x=f[s.status])==null?void 0:x.label)||s.status}),s.notes&&e.jsx("p",{className:"text-muted-foreground text-xs mt-0.5",children:s.notes})]})]},u)})})]})]})]}),e.jsxs(ie,{className:"flex justify-between items-center",children:[e.jsx(h,{variant:"secondary",onClick:()=>i(!1),children:"Fermer"}),t&&t.status==="sent"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(h,{variant:"outline",className:"border-red-300 text-red-600 hover:bg-red-50",onClick:()=>{T()},children:"Refuser"}),e.jsx(h,{className:"bg-green-600 hover:bg-green-700",onClick:()=>k(t.id),children:"Accepter"})]})]})]})}),e.jsx(ne,{open:c,onOpenChange:b,children:e.jsxs(ce,{children:[e.jsxs(de,{children:[e.jsx(oe,{children:"Refuser le devis"}),e.jsxs(ue,{children:["Veuillez indiquer la raison pour laquelle vous refusez ce devis.",t&&e.jsxs("p",{className:"mt-2 font-medium",children:["Devis: ",t.title||`Devis ${t.type}`]})]})]}),e.jsxs("div",{className:"py-4",children:[e.jsxs("label",{htmlFor:"declineReason",className:"block text-sm font-medium mb-2",children:["Raison du refus ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("textarea",{id:"declineReason",className:"w-full p-2 border border-gray-300 rounded-md",value:y,onChange:s=>C(s.target.value),placeholder:"Veuillez préciser pourquoi vous refusez ce devis...",rows:3,required:!0})]}),e.jsxs(me,{children:[e.jsx(xe,{children:"Annuler"}),e.jsx(he,{onClick:M,className:"bg-red-500 text-white hover:bg-red-600",children:"Confirmer le refus"})]})]})})]})};export{ze as default};
